<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeZone Mobile App</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
            border-bottom: 1px solid #333;
        }
        .log-error { color: #ff6b6b; }
        .log-success { color: #51cf66; }
        .log-info { color: #339af0; }
        .log-warning { color: #ffd43b; }
        
        .gps-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .gps-acquiring { background: #fff3cd; color: #856404; }
        .gps-success { background: #d1edff; color: #0c5460; }
        .gps-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <!-- <div class="debug-panel">
        <strong>ENHANCED GPS MODE</strong>
        <div>Incident ID: <span id="debug-incident">null</span></div>
        <div>GPS Status: <span id="debug-gps-status">Waiting...</span></div>
        <button onclick="clearDebug()">Clear Log</button>
        <div class="debug-log" id="debug-log"></div>
    </div> -->

    <div id="mobile-app">
        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <h1>SafeZone Emergency App</h1>
            <p>Please enter your details to continue</p>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="full-name">Full Name</label>
                    <input type="text" id="full-name" name="full_name" required placeholder="Enter your full name" value="Test User">
                </div>
                
                <div class="form-group">
                    <label for="phone-number">Phone Number</label>
                    <input type="tel" id="phone-number" name="phone_number" required placeholder="Enter your phone number" value="+1234567890">
                </div>
                
                <button type="submit" class="btn btn-primary">Continue to Safety App</button>
            </form>
        </div>

        <!-- Panic Button Screen -->
        <div id="panic-screen" class="panic-screen hidden">
            <h2>Emergency Assistance</h2>
            <p>In case of emergency, press the button below to alert security personnel.</p>
            
            <!-- GPS Status Display -->
            <div id="gps-status" class="gps-status gps-acquiring">
                üîÑ Acquiring your location...
            </div>
            
            <button id="panic-button" class="panic-button" disabled>
                GETTING LOCATION...<br>
                <small style="font-size: 12px;">Please wait</small>
            </button>
            
            <p style="color: #7f8c8d; font-size: 14px;">
                Your precise location will be shared with security dispatchers
            </p>

            <!-- Location Details -->
            <div id="location-details" class="hidden" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">üìç Location Acquired</h4>
                <div><strong>Coordinates:</strong> <span id="location-coords">0, 0</span></div>
                <div><strong>Accuracy:</strong> <span id="location-accuracy">0</span> meters</div>
                <div><strong>Method:</strong> <span id="location-method">GPS</span></div>
                <div><strong>Address:</strong> <span id="location-address">Resolving...</span></div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="chat-screen hidden">
            <div class="chat-header">
                Emergency Response - Incident #<span id="incident-id">0</span>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="Type your message...">
                <input type="file" id="media-upload" accept="image/*,video/*" class="hidden">
                <button type="button" class="upload-btn" onclick="document.getElementById('media-upload').click()">
                    üìé
                </button>
                <button type="button" class="btn btn-success" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced GPS System for 99% Accuracy
        let currentLocation = null;
        let locationWatchId = null;
        let locationRetryCount = 0;
        const MAX_RETRIES = 5;

        // Debug functions
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[GPS-DEBUG] ${message}`);
        }

        function updateGPSStatus(status, type = 'acquiring') {
            const statusDiv = document.getElementById('gps-status');
            statusDiv.textContent = status;
            statusDiv.className = `gps-status gps-${type}`;
            document.getElementById('debug-gps-status').textContent = status;
        }

        function clearDebug() {
            document.getElementById('debug-log').innerHTML = '';
        }

        function updateDebugIncident() {
            document.getElementById('debug-incident').textContent = currentIncidentId || 'null';
        }

        // Global variables
        let currentUser = null;
        let currentIncidentId = null;
        let chatRefreshInterval = null;

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const panicScreen = document.getElementById('panic-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginForm = document.getElementById('login-form');
        const panicButton = document.getElementById('panic-button');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const mediaUpload = document.getElementById('media-upload');
        const incidentIdSpan = document.getElementById('incident-id');

        // Event Listeners
        loginForm.addEventListener('submit', handleLogin);
        panicButton.addEventListener('click', triggerEmergencyAlert);
        mediaUpload.addEventListener('change', handleMediaUpload);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Enhanced GPS Acquisition System
        function initializeGPS() {
            debugLog('Initializing enhanced GPS system...', 'info');
            updateGPSStatus('üõ∞Ô∏è Starting location acquisition...', 'acquiring');
            
            // Start watching position with high accuracy
            startWatchingPosition();
            
            // Fallback: If no good location in 10 seconds, try alternative methods
            setTimeout(() => {
                if (!currentLocation || currentLocation.accuracy > 100) {
                    debugLog('Primary GPS taking too long, starting fallback methods...', 'warning');
                    tryEnhancedLocationMethods();
                }
            }, 10000);
        }

        function startWatchingPosition() {
            if (!navigator.geolocation) {
                debugLog('Geolocation API not available', 'error');
                updateGPSStatus('‚ùå GPS not supported', 'error');
                tryEnhancedLocationMethods();
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0,
                distanceFilter: 1 // Update every 1 meter movement
            };

            locationWatchId = navigator.geolocation.watchPosition(
                handlePositionSuccess,
                handlePositionError,
                options
            );

            debugLog('GPS watch started with high accuracy', 'success');
        }

        function handlePositionSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const altitude = position.coords.altitude;
            const heading = position.coords.heading;
            const speed = position.coords.speed;

            const newLocation = {
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                altitude: altitude,
                heading: heading,
                speed: speed,
                timestamp: new Date().toISOString(),
                method: 'gps',
                source: 'high_accuracy'
            };

            // Only update if accuracy improved or it's the first location
            if (!currentLocation || accuracy < currentLocation.accuracy) {
                currentLocation = newLocation;
                updateLocationDisplay();
                
                if (accuracy <= 50) {
                    debugLog(`High accuracy GPS: ${lat}, ${lng} (¬±${accuracy}m)`, 'success');
                    updateGPSStatus(`‚úÖ High Accuracy: ¬±${accuracy}m`, 'success');
                    enablePanicButton();
                } else if (accuracy <= 100) {
                    debugLog(`Medium accuracy GPS: ${lat}, ${lng} (¬±${accuracy}m)`, 'info');
                    updateGPSStatus(`üì° Good Accuracy: ¬±${accuracy}m`, 'success');
                    enablePanicButton();
                } else {
                    debugLog(`Low accuracy GPS: ${lat}, ${lng} (¬±${accuracy}m)`, 'warning');
                    updateGPSStatus(`üì∂ Fair Accuracy: ¬±${accuracy}m - Improving...`, 'acquiring');
                }
            }

            // Stop watching if we have excellent accuracy
            if (accuracy <= 20 && locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                debugLog('GPS watch stopped - excellent accuracy achieved', 'success');
            }
        }

        function handlePositionError(error) {
            let errorMsg = 'GPS Error: ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Location permission denied. Using alternative methods...';
                    debugLog('GPS permission denied', 'error');
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'GPS signal lost. Trying alternatives...';
                    debugLog('GPS position unavailable', 'error');
                    break;
                case error.TIMEOUT:
                    errorMsg = 'GPS timeout. Trying alternatives...';
                    debugLog('GPS timeout', 'warning');
                    break;
                default:
                    errorMsg = 'GPS error. Trying alternatives...';
                    debugLog(`GPS error: ${error.message}`, 'error');
                    break;
            }
            
            updateGPSStatus(errorMsg, 'error');
            
            // Try alternative methods
            if (locationRetryCount < MAX_RETRIES) {
                locationRetryCount++;
                setTimeout(() => tryEnhancedLocationMethods(), 2000);
            } else {
                tryEnhancedLocationMethods();
            }
        }

        function tryEnhancedLocationMethods() {
            debugLog(`Starting enhanced location methods (attempt ${locationRetryCount + 1})`, 'info');
            updateGPSStatus('üîÑ Trying enhanced location methods...', 'acquiring');

            // Method 1: Try with lower accuracy but faster
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    currentLocation = {
                        lat: lat,
                        lng: lng,
                        accuracy: accuracy,
                        method: 'gps_fallback',
                        source: 'standard_accuracy'
                    };
                    
                    updateLocationDisplay();
                    debugLog(`Fallback GPS: ${lat}, ${lng} (¬±${accuracy}m)`, 'success');
                    updateGPSStatus(`‚úÖ Location Acquired: ¬±${accuracy}m`, 'success');
                    enablePanicButton();
                },
                () => {
                    // Method 2: Try IP-based location
                    getIPBasedLocation().then(location => {
                        currentLocation = location;
                        updateLocationDisplay();
                        debugLog(`IP Location: ${location.lat}, ${location.lng}`, 'success');
                        updateGPSStatus('‚úÖ Approximate Location Acquired', 'success');
                        enablePanicButton();
                    }).catch(() => {
                        // Method 3: Try cell tower/wifi positioning
                        tryNetworkBasedLocation();
                    });
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function getIPBasedLocation() {
            return new Promise((resolve, reject) => {
                debugLog('Trying IP-based location...', 'info');
                
                // Try multiple IP geolocation services for redundancy
                const services = [
                    'https://ipapi.co/json/',
                    'https://ipinfo.io/json?token=test', // Remove token if not available
                    'https://api.ipgeolocation.io/ipgeo?apiKey=demo' // Use demo key or replace
                ];
                
                let attempts = 0;
                
                function tryNextService() {
                    if (attempts >= services.length) {
                        reject(new Error('All IP services failed'));
                        return;
                    }
                    
                    fetch(services[attempts])
                        .then(response => {
                            if (!response.ok) throw new Error('Service unavailable');
                            return response.json();
                        })
                        .then(data => {
                            let lat, lng;
                            
                            if (data.latitude && data.longitude) {
                                lat = parseFloat(data.latitude);
                                lng = parseFloat(data.longitude);
                            } else if (data.loc) {
                                [lat, lng] = data.loc.split(',').map(Number);
                            }
                            
                            if (lat && lng) {
                                resolve({
                                    lat: lat,
                                    lng: lng,
                                    accuracy: 5000, // IP location is approximate
                                    method: 'ip',
                                    country: data.country_name || data.country,
                                    city: data.city,
                                    service: services[attempts]
                                });
                            } else {
                                attempts++;
                                tryNextService();
                            }
                        })
                        .catch(() => {
                            attempts++;
                            tryNextService();
                        });
                }
                
                tryNextService();
            });
        }

        function tryNetworkBasedLocation() {
            debugLog('Trying network-based location...', 'info');
            
            // This would typically use cell tower or WiFi positioning
            // For now, we'll use a fallback to a known location
            const fallbackLocation = {
                lat: 14.5995, // Default Manila coordinates
                lng: 120.9842,
                accuracy: 10000,
                method: 'network_fallback',
                source: 'default_ph'
            };
            
            currentLocation = fallbackLocation;
            updateLocationDisplay();
            updateGPSStatus('üìç Default Location Set', 'success');
            enablePanicButton();
            debugLog('Using fallback network location', 'warning');
        }

        function updateLocationDisplay() {
            if (!currentLocation) return;
            
            document.getElementById('location-coords').textContent = 
                `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
            document.getElementById('location-accuracy').textContent = 
                Math.round(currentLocation.accuracy);
            document.getElementById('location-method').textContent = 
                currentLocation.method.toUpperCase();
                
            // Show location details
            document.getElementById('location-details').classList.remove('hidden');
            
            // Reverse geocode to get address
            reverseGeocode(currentLocation.lat, currentLocation.lng);
        }

        function reverseGeocode(lat, lng) {
            // Using OpenStreetMap Nominatim for reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        document.getElementById('location-address').textContent = 
                            data.display_name;
                    }
                })
                .catch(error => {
                    document.getElementById('location-address').textContent = 
                        'Address not available';
                });
        }

        function enablePanicButton() {
            panicButton.disabled = false;
            panicButton.innerHTML = 'EMERGENCY<br>ALERT';
            panicButton.style.backgroundColor = '#e74c3c';
        }

        // Handle user login
        function handleLogin(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            currentUser = {
                full_name: formData.get('full_name'),
                phone_number: formData.get('phone_number')
            };
            
            debugLog(`User logged in: ${currentUser.full_name}`, 'success');
            
            // Show panic screen and initialize GPS
            loginScreen.classList.add('hidden');
            panicScreen.classList.remove('hidden');
            initializeGPS();
        }

        // Trigger emergency alert with enhanced location
        function triggerEmergencyAlert() {
            if (!currentLocation) {
                debugLog('No location available for emergency alert!', 'error');
                alert('Please wait for location acquisition...');
                return;
            }

            debugLog('Starting emergency alert with enhanced location...', 'info');
            updateGPSStatus('üö® SENDING EMERGENCY ALERT...', 'acquiring');
            panicButton.disabled = true;
            panicButton.style.backgroundColor = '#95a5a6';

            const postData = new URLSearchParams({
                full_name: currentUser.full_name,
                phone_number: currentUser.phone_number,
                gps_lat: currentLocation.lat,
                gps_lng: currentLocation.lng,
                gps_accuracy: currentLocation.accuracy,
                location_method: currentLocation.method,
                altitude: currentLocation.altitude || 0,
                heading: currentLocation.heading || 0,
                speed: currentLocation.speed || 0
            });

            debugLog(`Sending enhanced location data: ${postData}`, 'info');

            // Send alert to server
            fetch('api.php?action=alert_trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: postData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                debugLog(`Server response: ${JSON.stringify(data)}`, 'info');
                
                if (data.success) {
                    currentIncidentId = data.data.incident_id;
                    debugLog(`Incident created! ID: ${currentIncidentId}`, 'success');
                    updateDebugIncident();
                    
                    incidentIdSpan.textContent = currentIncidentId;
                    
                    // Switch to chat screen
                    panicScreen.classList.add('hidden');
                    chatScreen.classList.remove('hidden');
                    
                    // Start chat refresh
                    startChatRefresh();
                    
                    // Add initial emergency message with location
                    addMessageToChat(
                        `EMERGENCY ALERT: I need help! Location: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)} (Accuracy: ¬±${Math.round(currentLocation.accuracy)}m)`,
                        'user'
                    );
                } else {
                    debugLog(`Alert failed: ${data.error}`, 'error');
                    alert('Error triggering alert: ' + data.error);
                    panicButton.disabled = false;
                    panicButton.style.backgroundColor = '#e74c3c';
                }
            })
            .catch(error => {
                debugLog(`Fetch error: ${error.message}`, 'error');
                alert('Error triggering emergency alert: ' + error.message);
                panicButton.disabled = false;
                panicButton.style.backgroundColor = '#e74c3c';
            });
        }

        // [Rest of your existing functions remain the same...]
        // sendMessage, handleMediaUpload, startChatRefresh, refreshChat, displayMessages, addMessageToChat

        // Initialize
        debugLog('Enhanced GPS SafeZone loaded', 'success');
        // Show debug panel by default for testing
        document.querySelector('.debug-panel').style.display = 'block';

        // Existing functions from your original code...
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message && !mediaUpload.files[0]) {
                debugLog('No message or media to send', 'error');
                return;
            }

            debugLog(`Attempting to send message for incident: ${currentIncidentId}`, 'info');

            if (!currentIncidentId) {
                debugLog('No incident ID available!', 'error');
                alert('Error: No active incident. Please trigger an emergency alert first.');
                return;
            }

            const formData = new FormData();
            formData.append('incident_id', currentIncidentId);
            formData.append('sender', 'user');
            formData.append('message_text', message);
            
            if (mediaUpload.files[0]) {
                formData.append('media', mediaUpload.files[0]);
                debugLog(`Media file: ${mediaUpload.files[0].name}`, 'info');
            }

            debugLog(`Sending message: "${message}"`, 'info');

            fetch('api.php?action=send_message', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                debugLog(`Send message response status: ${response.status}`, 'info');
                return response.json();
            })
            .then(data => {
                debugLog(`Send message result: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
                if (data.success) {
                    messageInput.value = '';
                    mediaUpload.value = '';
                    refreshChat();
                } else {
                    alert('Error sending message: ' + data.error);
                }
            })
            .catch(error => {
                debugLog(`Send message error: ${error.message}`, 'error');
                alert('Error sending message: ' + error.message);
            });
        }

        function handleMediaUpload() {
            if (this.files[0]) {
                debugLog('Media file selected, auto-sending...', 'info');
                sendMessage();
            }
        }

        function startChatRefresh() {
            debugLog('Starting chat refresh interval', 'info');
            refreshChat(); // Initial load
            chatRefreshInterval = setInterval(refreshChat, 3000);
        }

        function refreshChat() {
            if (!currentIncidentId) {
                debugLog('No incident ID for chat refresh', 'error');
                return;
            }

            debugLog(`Refreshing chat for incident: ${currentIncidentId}`, 'info');

            fetch(`api.php?action=get_chat&incident_id=${currentIncidentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        debugLog(`Loaded ${data.data.messages.length} messages`, 'success');
                        displayMessages(data.data.messages);
                    } else {
                        debugLog(`Chat refresh failed: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    debugLog(`Chat refresh error: ${error.message}`, 'error');
                });
        }

        function displayMessages(messages) {
            chatMessages.innerHTML = '';
            messages.forEach(message => {
                addMessageToChat(message.message_text, message.sender, message.media_path, message.created_at);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessageToChat(text, sender, mediaPath = null, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                bubbleDiv.appendChild(textDiv);
            }
            
            if (mediaPath) {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = 'media-attachment';
                
                if (mediaPath.match(/\.(jpg|jpeg|png|gif)$/i)) {
                    const img = document.createElement('img');
                    img.src = mediaPath;
                    img.alt = 'Uploaded image';
                    mediaDiv.appendChild(img);
                } else if (mediaPath.match(/\.(mp4|mov|avi)$/i)) {
                    const video = document.createElement('video');
                    video.src = mediaPath;
                    video.controls = true;
                    video.style.maxWidth = '200px';
                    mediaDiv.appendChild(video);
                }
                
                bubbleDiv.appendChild(mediaDiv);
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            messageDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(timeDiv);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        // Replace your testAPI function with this:
function testAPI() {
    debugLog('Testing API connection...', 'info');
    fetch('api.php?action=test_connection')
        .then(response => {
            // First, check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Check PHP errors.');
            }
            return response.json();
        })
        .then(data => {
            debugLog(`API Test: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
        })
        .catch(error => {
            debugLog(`API Test Error: ${error.message}`, 'error');
            // Try to get the raw response to see the error
            fetch('api.php?action=test_connection')
                .then(r => r.text())
                .then(text => {
                    debugLog(`Raw server response: ${text.substring(0, 200)}`, 'error');
                });
        });
}
    </script>
</body>
</html>